// This is your Prisma schema file for MemeVerse

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with auth and gamification
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String
  username         String?   @unique
  password         String?
  image            String?
  bio              String?
  location         String?
  website          String?
  googleId         String?   @unique
  coins            Int       @default(100)
  level            Int       @default(1)
  xp               Int       @default(0)
  role             String    @default("USER")
  totalMemes       Int       @default(0)
  totalComments    Int       @default(0)
  totalLikes       Int       @default(0)
  streak           Int       @default(0)
  referralCode     String?   @unique
  referredBy       String?
  isPremium        Boolean   @default(false)
  premiumExpiry    DateTime?
  isVerified       Boolean   @default(false)
  lastLogin        DateTime?
  lastStreakUpdate DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  memes            Meme[]          @relation("UserMemes")
  comments         Comment[]
  votes            Vote[]
  badges           UserBadge[]
  notifications    Notification[]  @relation("UserNotifications")
  bookmarks        Bookmark[]
  reportsCreated   Report[]        @relation("ReportReporter")
  reportsReceived  Report[]        @relation("ReportReportedUser")
  referralsSent    Referral[]      @relation("Referrer")
  referralReceived Referral?       @relation("Referred")
  followers        Follow[]        @relation("Following")
  following        Follow[]        @relation("Follower")
  topicFollows     TopicFollow[]
  transactions     Transaction[]
  sessions         Session[]
  accounts         Account[]

  // Indexes
  @@index([email])
  @@index([username])
  @@index([referralCode])
  @@index([createdAt])
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

// Verification Token model (for email verification)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Meme/Post model with video support
model Meme {
  id           String   @id @default(cuid())
  title        String
  imageUrl     String
  videoUrl     String?
  caption      String?
  category     String
  tags         String?  // Comma-separated tags
  region       String?
  school       String?
  authorId     String
  isAnonymous  Boolean  @default(false)
  viralScore   Int      @default(0)
  views        Int      @default(0)
  shares       Int      @default(0)
  isVideo      Boolean  @default(false)
  isPremium    Boolean  @default(false) // Premium-only memes
  isFeatured   Boolean  @default(false)
  isNSFW       Boolean  @default(false)
  isReported   Boolean  @default(false)
  reportCount  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  author       User         @relation("UserMemes", fields: [authorId], references: [id], onDelete: Cascade)
  comments     Comment[]
  votes        Vote[]
  bookmarks    Bookmark[]
  topics       MemeTopic[]
  memeReports  Report[]

  // Indexes
  @@index([authorId])
  @@index([category])
  @@index([createdAt])
  @@index([viralScore])
  @@index([isFeatured])
}

// Comment model
model Comment {
  id        String   @id @default(cuid())
  content   String
  memeId    String
  userId    String
  parentId  String?  // For nested comments
  likes     Int      @default(0)
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  meme       Meme     @relation(fields: [memeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent     Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies    Comment[] @relation("CommentReplies")

  // Indexes
  @@index([memeId])
  @@index([userId])
  @@index([parentId])
}

// Vote model (like/dislike)
model Vote {
  id        String   @id @default(cuid())
  type      String   // 'up' or 'down'
  memeId    String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  meme      Meme     @relation(fields: [memeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([memeId, userId])
  @@index([memeId])
  @@index([userId])
  @@index([type])
}

// Badge/Achievement model
model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  icon        String?
  color       String?
  coinReward  Int      @default(0)
  xpReward    Int      @default(0)
  level       Int      @default(1)
  category    String   // 'content', 'social', 'special', 'milestone'
  requirement Int      @default(1) // e.g., 10 memes, 50 likes, etc.
  isHidden    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  userBadges  UserBadge[]

  // Indexes
  @@index([category])
  @@index([level])
}

// User-Badge junction table with progress
model UserBadge {
  id          String   @id @default(cuid())
  userId      String
  badgeId     String
  progress    Int      @default(0)
  target      Int      @default(1)
  earnedAt    DateTime @default(now())
  isEquipped  Boolean  @default(false)

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

// Notification model
model Notification {
  id        String   @id @default(cuid())
  type      String   // 'like', 'comment', 'badge', 'coin', 'follow', 'system', 'premium', 'mention'
  title     String
  message   String
  userId    String
  isRead    Boolean  @default(false)
  actionUrl String?  // URL to navigate when clicked
  metadata  String?  // JSON string for additional data
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// Bookmark model
model Bookmark {
  id        String   @id @default(cuid())
  memeId    String
  userId    String
  folder    String?  @default("default")
  createdAt DateTime @default(now())

  // Relations
  meme      Meme     @relation(fields: [memeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([memeId, userId])
  @@index([userId])
  @@index([folder])
}

// Report/Bug report model
model Report {
  id             String   @id @default(cuid())
  type           String   // 'bug', 'content', 'user', 'meme'
  title          String
  content        String
  memeId         String?
  reportedUserId String?
  reporterId     String
  status         String   @default("pending") // 'pending', 'reviewed', 'resolved', 'dismissed'
  priority       String   @default("medium")  // 'low', 'medium', 'high', 'critical'
  resolvedAt     DateTime?
  resolvedBy     String?
  resolutionNote String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  reporter       User     @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  meme           Meme?    @relation(fields: [memeId], references: [id])
  reportedUser   User?    @relation("ReportReportedUser", fields: [reportedUserId], references: [id])

  // Indexes
  @@index([type])
  @@index([status])
  @@index([reporterId])
  @@index([createdAt])
}

// FAQ model
model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([category])
  @@index([order])
}

// Topic model for following topics
model Topic {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  memeCount   Int      @default(0)
  isTrending  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  followers   TopicFollow[]
  memes       MemeTopic[]

  // Indexes
  @@index([slug])
  @@index([isTrending])
  @@index([memeCount])
}

// Topic-Follow junction table
model TopicFollow {
  id        String   @id @default(cuid())
  userId    String
  topicId   String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([topicId])
}

// Meme-Topic junction table
model MemeTopic {
  id        String   @id @default(cuid())
  memeId    String
  topicId   String
  createdAt DateTime @default(now())

  // Relations
  meme      Meme     @relation(fields: [memeId], references: [id], onDelete: Cascade)
  topic     Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([memeId, topicId])
  @@index([memeId])
  @@index([topicId])
}

// Follow model for following users
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  // Relations
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Referral model
model Referral {
  id            String   @id @default(cuid())
  referrerId    String
  referredId    String   @unique
  coinReward    Int      @default(50)
  xpReward      Int      @default(10)
  status        String   @default("pending") // 'pending', 'completed', 'expired'
  completedAt   DateTime?
  createdAt     DateTime @default(now())

  // Relations
  referrer      User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser  User     @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([referrerId])
  @@index([status])
}

// Transaction model for coin transactions
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  type        String   // 'earned', 'spent', 'referral', 'premium', 'reward', 'purchase', 'refund'
  amount      Int
  balance     Int      // Balance after transaction
  description String
  metadata    String?  // JSON string for additional data
  referenceId String?  // Reference to related entity (memeId, badgeId, etc.)
  createdAt   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// Level system model
model Level {
  id          String   @id @default(cuid())
  levelNumber Int      @unique
  xpRequired  Int
  coinReward  Int      @default(0)
  badgeReward String?
  title       String?
  perks       String?  // JSON string for perks
  createdAt   DateTime @default(now())

  // Indexes
  @@index([levelNumber])
}

// Ads/Sponsorship model
model Ad {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String
  advertiser  String
  budget      Float    @default(0)
  impressions Int      @default(0)
  clicks      Int      @default(0)
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  targetTags  String?  // Comma-separated tags for targeting
  targetRegion String?
  priority    Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  adImpressions AdImpression[]

  // Indexes
  @@index([isActive])
  @@index([endDate])
  @@index([priority])
}

// Ad impression tracking
model AdImpression {
  id        String   @id @default(cuid())
  adId      String
  userId    String?
  memeId    String?
  type      String   // 'view', 'click'
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  ad        Ad      @relation(fields: [adId], references: [id], onDelete: Cascade)
  user      User?   @relation(fields: [userId], references: [id])
  meme      Meme?   @relation(fields: [memeId], references: [id])

  // Indexes
  @@index([adId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// Meme of the Day model
model MemeOfTheDay {
  id        String   @id @default(cuid())
  memeId    String   @unique
  date      DateTime @unique
  votes     Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  meme      Meme     @relation(fields: [memeId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([date])
}

// User Activity Log
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // 'login', 'logout', 'create_meme', 'like', 'comment', 'follow'
  details   String?  // JSON string with additional details
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// User Settings/Preferences
model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  emailNotifications Boolean  @default(true)
  pushNotifications Boolean  @default(true)
  darkMode          Boolean  @default(false)
  language          String   @default("en")
  privacyLevel      String   @default("public") // 'public', 'friends', 'private'
  contentFilter     String   @default("moderate") // 'strict', 'moderate', 'lenient'
  autoplayVideos    Boolean  @default(true)
  showNSFW          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Chat/Message model
model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  content    String
  isRead     Boolean  @default(false)
  isDeleted  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([senderId, receiverId])
  @@index([createdAt])
}

// Premium Subscription Plans
model SubscriptionPlan {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  price       Float
  duration    Int      // in days
  coinBonus   Int      @default(0)
  badgeId     String?
  features    String?  // JSON array of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  badge       Badge?   @relation(fields: [badgeId], references: [id])
}

// User Subscription
model UserSubscription {
  id               String   @id @default(cuid())
  userId           String
  planId           String
  transactionId    String?  @unique
  startDate        DateTime
  endDate          DateTime
  status           String   @default("active") // 'active', 'expired', 'cancelled'
  autoRenew        Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  transaction      Transaction?     @relation(fields: [transactionId], references: [id])

  // Indexes
  @@unique([userId, planId])
  @@index([userId])
  @@index([status])
  @@index([endDate])
}
